---
title: "TrafficAssig.jl"
format: gfm
---

TrafficAssig is a Julia package for...

1. Load [Transportation Networks](https://github.com/bstabler/TransportationNetworks) data or construct traffic data from data frames.
1. Traffic assignment with User Equilibrium.

## Load traffic data

`load_tntp()` loads [Transportation Networks](https://github.com/bstabler/TransportationNetworks) data ([TNTP](https://www.bgu.ac.il/~bargera/tntp/) format).

`Traffic()` creates traffic data from trip and network data frames.

```{julia}
#| label: load-traffic-data
#| warning: false

using TrafficAssig

tntp = load_tntp("Anaheim")
```

```{julia}
#| label: save-traffic-data
#| eval: false
#| echo: false

using TrafficAssig
using CSV

tntp = load_tntp("SiouxFalls")

if !isdir("README_files/traffic-data/SiouxFalls")
    mkpath("README_files/traffic-data/SiouxFalls")
end

CSV.write("README_files/traffic-data/SiouxFalls/trips.csv", tntp.trips)
CSV.write("README_files/traffic-data/SiouxFalls/network.csv", tntp.network)
```

<!-- 
```{julia}
#| label: load-traffic-data-csv
#| echo: false
#| output: false

using CSV
using DataFrames

trips = CSV.read("README_files/traffic-data/SiouxFalls/trips.csv", DataFrame)
network = CSV.read("README_files/traffic-data/SiouxFalls/network.csv", DataFrame)
```

```{julia}
trips
network

Traffic(trips, network)
```
-->

## Traffic assignment

`assign_traffic()` solves traffic assignment problems.
By default, the `BiconjugateFrankWolfe()` algorithm is used.

```{julia}
#| label: traffic-assignment

res = assign_traffic(tntp)
```

```{julia}
#| label: traffic-assignment-flow
res.flow
```

```{julia}
#| label: save-traffic-assignment-results
#| echo: false
#| output: false

function frank_wolfe_results(res)
    traffic = res.traffic
    flow = DataFrame(
        from=traffic.from,
        to=traffic.to,
        flow=res.flow
    )

    logs = res.logs
    logs = DataFrame(
        exec_time=logs.exec_time,
        objective=logs.objective,
        relative_gap=logs.relative_gap
    )

    return flow, logs
end

flow, logs = frank_wolfe_results(res)

if !isdir("README_files/frank-wolfe-results/Anaheim")
    mkpath("README_files/frank-wolfe-results/Anaheim")
end

CSV.write("README_files/frank-wolfe-results/Anaheim/flow.csv", flow)
CSV.write("README_files/frank-wolfe-results/Anaheim/logs.csv", logs)
```

```{r}
#| label: plot-a-network
#| echo: false
#| warning: false

library(tidyverse)
library(fs)
library(sf)

theme_set(theme_light())

flow <- read_csv("README_files/frank-wolfe-results/Anaheim/flow.csv",
                 col_types = cols(.default = "n"))

network <- dir_ls(regexp = "^TransportationNetworks[^/]+/Anaheim/anaheim.geojson$", 
                  recurse = TRUE) |>
  read_sf() |>
  select(init_node, term_node) |>
  left_join(flow,
            by = c("init_node" = "from",
                   "term_node" = "to"))

ggplot(network,
       aes(color = flow)) +
  geom_sf() +
  scale_color_viridis_c(option = "turbo") +
  labs(caption = "\U00a9 OpenStreetMap contributors")
```

## Traffic assignment algorithms

Now, the following algorithms are available.

- `FrankWolfe()`
- `ConjugateFrankWolfe()`
- `BiconjugateFrankWolfe()`

```{julia}
#| label: compare-algorithms
#| eval: false

# Requires long execution time.
tntp = load_tntp("GoldCoast")

res_FW = assign_traffic(tntp, algorithm=FrankWolfe())
res_CFW = assign_traffic(tntp, algorithm=ConjugateFrankWolfe())
res_BFW = assign_traffic(tntp, algorithm=BiconjugateFrankWolfe())
```

```{julia}
#| label: save-frank-wolfe-results
#| eval: false
#| echo: false

if !isdir("README_files/frank-wolfe-results/GoldCoast")
    mkpath("README_files/frank-wolfe-results/GoldCoast")
end

flow_FW, logs_FW = frank_wolfe_results(res_FW)
flow_CFW, logs_CFW = frank_wolfe_results(res_CFW)
flow_BFW, logs_BFW = frank_wolfe_results(res_BFW)

CSV.write("README_files/frank-wolfe-results/GoldCoast/flow_FW.csv", flow_FW)
CSV.write("README_files/frank-wolfe-results/GoldCoast/flow_CFW.csv", flow_CFW)
CSV.write("README_files/frank-wolfe-results/GoldCoast/flow_BFW.csv", flow_BFW)

CSV.write("README_files/frank-wolfe-results/GoldCoast/logs_FW.csv", logs_FW)
CSV.write("README_files/frank-wolfe-results/GoldCoast/logs_CFW.csv", logs_CFW)
CSV.write("README_files/frank-wolfe-results/GoldCoast/logs_BFW.csv", logs_BFW)
```

```{julia}
#| label: load-frank-wolfe results
#| echo: false
#| output: false

logs_FW = CSV.read("README_files/frank-wolfe-results/GoldCoast/logs_FW.csv", DataFrame)
logs_CFW = CSV.read("README_files/frank-wolfe-results/GoldCoast/logs_CFW.csv", DataFrame)
logs_BFW = CSV.read("README_files/frank-wolfe-results/GoldCoast/logs_BFW.csv", DataFrame)
```

```{julia}
#| label: make-a-plot-frank-wolfe-results
#| echo: false
#| output: false

using Plots

plt = plot(
    1:nrow(logs_FW), logs_FW.relative_gap, 
    yaxis=:log,
    xlabel="Iteration",
    # xlabel="Execution Time [sec]",
    ylabel="Relative Gap",
    label="Frank-Wolfe"
)
plot!(
    1:nrow(logs_CFW), logs_CFW.relative_gap, 
    label="Conjugate Frank-Wolfe"
)
plot!(
    1:nrow(logs_BFW), logs_BFW.relative_gap, 
    label="Biconjugate Frank-Wolfe"
)
```

```{julia}
#| label: plot-frank-wolfe-results
#| echo: false

plt
```

<!-- ## Comparisons -->